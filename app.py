import streamlit as st
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseDownload
import google.generativeai as genai
import gspread
from PIL import Image
import random
import speech_recognition as sr
from streamlit_mic_recorder import mic_recorder
import asyncio
import edge_tts
import tempfile
import os
import re
import io
import PyPDF2

# ==========================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©
# ==========================================
st.set_page_config(
    page_title="Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ | Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø¨Ø¯ÙˆÙŠ",
    page_icon="ğŸ§¬",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ==========================================
# 2. ØªØµÙ…ÙŠÙ… Ø¢Ù…Ù† ÙˆÙˆØ§Ø¶Ø­ (Safe & Clear UI)
# ==========================================
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
    
    /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø§ØªØ¬Ø§Ù‡ */
    html, body, [class*="css"] {
        font-family: 'Cairo', sans-serif;
        direction: rtl;
        text-align: right;
    }
    
    /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    .stApp {
        background-color: #f7f9fc;
    }
    
    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ØªÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ø© Ø¨ÙˆØ¶ÙˆØ­ --- */
    /* Ø­Ø¯ÙˆØ¯ Ø²Ø±Ù‚Ø§Ø¡ØŒ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ØŒ Ù†Øµ Ø£Ø³ÙˆØ¯ */
    .stTextInput input, .stSelectbox div, .stTextArea textarea {
        background-color: #ffffff !important;
        color: #000000 !important;
        border: 1px solid #ced4da !important;
        border-radius: 8px !important;
    }
    
    /* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ (Label) */
    .stTextInput label, .stSelectbox label {
        color: #000000 !important;
        font-weight: bold !important;
        font-size: 16px !important;
    }

    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
    .stButton>button {
        background-color: #2c3e50; /* Ù„ÙˆÙ† ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ */
        color: #ffffff !important;
        border-radius: 8px;
        height: 50px;
        width: 100%;
        font-size: 18px !important;
        font-weight: bold !important;
        border: none;
    }
    .stButton>button:hover {
        background-color: #34495e;
    }

    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
    .header-box {
        background: linear-gradient(135deg, #000428 0%, #004e92 100%);
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .header-box h1, .header-box h3 {
        color: #ffffff !important;
        margin: 0;
    }
    
    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© --- */
    .stChatMessage {
        background-color: #ffffff !important;
        border: 1px solid #e1e4e8 !important;
        border-radius: 12px !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    }
    
    /* Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª */
    .stChatMessage p {
        color: #000000 !important;
        font-size: 17px !important;
    }
</style>
""", unsafe_allow_html=True)

st.markdown("""
<div class="header-box">
    <h1>Ø§Ù„Ø£Ø³ØªØ§Ø° / Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø¨Ø¯ÙˆÙŠ</h1>
    <h3>Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© (Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ - Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ - Ø«Ø§Ù†ÙˆÙŠ)</h3>
</div>
""", unsafe_allow_html=True)

# ==========================================
# 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
# ==========================================
if 'user_data' not in st.session_state:
    st.session_state.user_data = {"logged_in": False, "role": None, "name": "", "grade": "", "stage": "", "lang": ""}
if 'messages' not in st.session_state: st.session_state.messages = []
if 'book_content' not in st.session_state: st.session_state.book_content = ""

# ==========================================
# 4. Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ==========================================
TEACHER_KEY = st.secrets.get("TEACHER_MASTER_KEY", "ADMIN")
SHEET_NAME = st.secrets.get("CONTROL_SHEET_NAME", "App_Control")

@st.cache_resource
def get_credentials():
    if "gcp_service_account" not in st.secrets: return None
    try:
        creds_dict = dict(st.secrets["gcp_service_account"])
        if "private_key" in creds_dict:
            creds_dict["private_key"] = creds_dict["private_key"].replace("\\n", "\n")
        scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
        return service_account.Credentials.from_service_account_info(creds_dict, scopes=scopes)
    except: return None

def get_gspread_client():
    creds = get_credentials()
    return gspread.authorize(creds) if creds else None

def check_student_code(input_code):
    client = get_gspread_client()
    if not client: return False
    try:
        sh = client.open(SHEET_NAME)
        real_code = str(sh.sheet1.acell("B1").value).strip()
        return str(input_code).strip() == real_code
    except: return False

@st.cache_resource
def get_book_text_from_drive(stage, grade, lang):
    creds = get_credentials()
    if not creds: return None
    try:
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø¯Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        file_prefix = ""
        if "Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©" in stage:
            mapping = {"Ø§Ù„Ø£ÙˆÙ„": "Sec1", "Ø§Ù„Ø«Ø§Ù†ÙŠ": "Sec2", "Ø§Ù„Ø«Ø§Ù„Ø«": "Sec3"}
            file_prefix = mapping.get(grade, "Sec1")
        elif "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©" in stage:
            mapping = {"Ø§Ù„Ø£ÙˆÙ„": "Prep1", "Ø§Ù„Ø«Ø§Ù†ÙŠ": "Prep2", "Ø§Ù„Ø«Ø§Ù„Ø«": "Prep3"}
            file_prefix = mapping.get(grade, "Prep1")
        else: # Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            mapping = {"Ø§Ù„Ø±Ø§Ø¨Ø¹": "Grade4", "Ø§Ù„Ø®Ø§Ù…Ø³": "Grade5", "Ø§Ù„Ø³Ø§Ø¯Ø³": "Grade6"}
            file_prefix = mapping.get(grade, "Grade4")
            
        lang_code = "Ar" if "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" in lang else "En"
        expected_name = f"{file_prefix}_{lang_code}"
        
        service = build('drive', 'v3', credentials=creds)
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù
        results = service.files().list(q=f"name contains '{expected_name}' and mimeType='application/pdf'", fields="files(id, name)").execute()
        files = results.get('files', [])
        
        if not files: return None
        
        # ØªØ­Ù…ÙŠÙ„ ÙˆÙ‚Ø±Ø§Ø¡Ø©
        request = service.files().get_media(fileId=files[0]['id'])
        file_stream = io.BytesIO()
        downloader = MediaIoBaseDownload(file_stream, request)
        done = False
        while done is False: status, done = downloader.next_chunk()
        
        file_stream.seek(0)
        pdf_reader = PyPDF2.PdfReader(file_stream)
        text = ""
        # Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ 60 ØµÙØ­Ø© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²Ø§Ø¦Ø¯
        for page in pdf_reader.pages[:60]: text += page.extract_text() + "\n"
        return text
    except: return None

# ==========================================
# 5. Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
# ==========================================
def clean_text_for_speech(text):
    text = re.sub(r'[\*\#\-\_]', '', text)
    return text
